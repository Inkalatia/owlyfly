<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0">
		<title>Owly Fly!</title>
		<style>
html, body, #canvas {
	margin: 0;
	padding: 0;
	border: 0;
}

body {
	color: white;
	background-color: black;
	overflow: hidden;
	touch-action: none;
}

#canvas {
	display: block;
}

#canvas:focus {
	outline: none;
}

#status, #status-splash, #status-progress {
	position: absolute;
	left: 0;
	right: 0;
}

#status, #status-splash {
	top: 0;
	bottom: 0;
}

#status {
	background-color: #242424;
	display: flex;
	flex-direction: column;
	justify-content: center;
	align-items: center;
	visibility: hidden;
}

#status-splash {
	max-height: 100%;
	max-width: 100%;
	margin: auto;
}

#status-progress, #status-notice {
	display: none;
}

#status-progress {
	bottom: 10%;
	width: 50%;
	margin: 0 auto;
}

#status-notice {
	background-color: #5b3943;
	border-radius: 0.5rem;
	border: 1px solid #9b3943;
	color: #e0e0e0;
	font-family: 'Noto Sans', 'Droid Sans', Arial, sans-serif;
	line-height: 1.3;
	margin: 0 2rem;
	overflow: hidden;
	padding: 1rem;
	text-align: center;
	z-index: 1;
}
		</style>
		<link id="-gd-engine-icon" rel="icon" type="image/png" href="index.icon.png" />
<link rel="apple-touch-icon" href="index.apple-touch-icon.png"/>
<link rel="manifest" href="index.manifest.json">
<style>
@font-face {
  font-family: "ComicSansChinese";
  src: url("Ldfcomicsansbold-zgma.ttf");
}
</style>
<link rel="stylesheet" href="custom.css">
	</head>
	<body>
		<canvas id="canvas">
			Your browser does not support the canvas tag.
		</canvas>

		<noscript>
			Your browser does not support JavaScript.
		</noscript>

		<div id="status">
			<img id="status-splash" src="index.png" alt="">
			<progress id="status-progress"></progress>
			<div id="status-notice"></div>
		</div>

		<script src="index.js"></script>
		<script>
// 使用 GitHub Pages 直接加载 wasm，使用 jsDelivr CDN 加载 pck chunks
const GODOT_CONFIG = {
    "args": [],
    "canvasResizePolicy": 2,
    "ensureCrossOriginIsolationHeaders": false, // 在 GitHub Pages 上保持禁用
    "executable": "index.wasm", // 直接使用 GitHub 上的文件
    "experimentalVK": false,
    "fileSizes": {"index.pck": 203326128, "index.wasm": 33829596},
    "focusCanvas": true,
    "gdextensionLibs": [],
    "serviceWorker": null // 禁用 Service Worker
};

const GODOT_THREADS_ENABLED = false; // 在 GitHub Pages 上禁用线程
const engine = new Engine(GODOT_CONFIG);

// 配置：您的 GitHub 用户名、仓库名和分支名
const userName = "Inkalatia";
const repoName = "owlyfly";
const branch = "main";

// 定义 pck 文件的分块列表（根据您之前上传的文件调整顺序和数量）
const pckChunks = [
    'index.pck.part.00',
    'index.pck.part.01',
    'index.pck.part.02',
    'index.pck.part.03',
    'index.pck.part.04',
    'index.pck.part.05',
    'index.pck.part.06',
    'index.pck.part.07',
    'index.pck.part.08',
    'index.pck.part.09',
    'index.pck.part.10'
].map(chunk => `https://cdn.jsdelivr.net/gh/${userName}/${repoName}@${branch}/${chunk}`); // 映射为 jsDelivr 链接

(async function() {
    // ... (保留您现有的 setStatusMode, displayFailureNotice 等函数) ...

    async function loadAndCombineChunks(chunkUrls, chunkType) {
        const chunkBuffers = [];
        for (let i = 0; i < chunkUrls.length; i++) {
            try {
                const response = await fetch(chunkUrls[i]);
                if (!response.ok) throw new Error(`Failed to download ${chunkType} chunk ${i+1}`);
                const buffer = await response.arrayBuffer();
                chunkBuffers.push(buffer);
                console.log(`Downloaded ${chunkType} chunk ${i+1}/${chunkUrls.length}`);
            } catch (error) {
                console.error(`Error downloading chunk ${i+1}:`, error);
                throw error;
            }
        }
        const totalLength = chunkBuffers.reduce((acc, buffer) => acc + buffer.byteLength, 0);
        const combinedBuffer = new Uint8Array(totalLength);
        let offset = 0;
        for (const buffer of chunkBuffers) {
            combinedBuffer.set(new Uint8Array(buffer), offset);
            offset += buffer.byteLength;
        }
        return combinedBuffer.buffer;
    }

    try {
        setStatusMode('progress');
        console.log('Loading and assembling pck chunks from jsDelivr...');
        // 只下载和组合 pck chunks
        const pckArrayBuffer = await loadAndCombineChunks(pckChunks, 'pck');
        const pckBlob = new Blob([pckArrayBuffer], { type: 'application/octet-stream' });
        const pckBlobUrl = URL.createObjectURL(pckBlob);

        // 直接使用 GitHub 上的 index.wasm，传递组合后的 pck Blob
        await engine.startGame({
            'executable': './index.wasm', // 相对路径指向 GitHub Pages 上的文件
            'mainPack': pckBlobUrl, // 使用组合后的 pck Blob
            'onProgress': function(current, total) {
                // ... (您的进度条代码) ...
            },
        });
        URL.revokeObjectURL(pckBlobUrl); // 清理
        setStatusMode('hidden');
    } catch (error) {
        console.error('Failed to start game:', error);
        displayFailureNotice('Failed to load the game. Please try refreshing the page. Error: ' + error.message);
    }
})();
</script>
	</body>
</html>